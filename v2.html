<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sugarbush Signal | Seasonal Intelligence</title>
    <style>
        body { font-family: system-ui, sans-serif; background: #fcf8f2; color: #333; padding: 20px; max-width: 850px; margin: 0 auto; }
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); border-top: 8px solid #6d4c41; }
        h1 { color: #5d4037; text-align: center; margin-top: 0; margin-bottom: 5px; letter-spacing: -1px; }
        .subtitle { text-align: center; font-size: 14px; color: #8d6e63; margin-bottom: 25px; text-transform: uppercase; font-weight: bold; }
        .trivia-box { background: #efebe9; border-left: 5px solid #8d6e63; padding: 15px; margin-bottom: 20px; font-style: italic; font-size: 14px; color: #4e342e; border-radius: 4px; }
        .input-group { display: flex; gap: 10px; margin-bottom: 20px; }
        input { flex: 1; padding: 12px; border: 2px solid #d7ccc8; border-radius: 8px; font-size: 16px; outline-color: #8d6e63; }
        button { padding: 12px 24px; background: #5d4037; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; transition: background 0.2s; }
        button:hover { background: #4e342e; }
        
        #gddWrapper { margin: 20px 0; display: none; background: #fafafa; padding: 15px; border-radius: 8px; border: 1px solid #efebe9; }
        .gdd-container { background: #e0e0e0; border-radius: 12px; height: 18px; position: relative; overflow: hidden; margin-top: 8px; }
        .gdd-bar { background: linear-gradient(90deg, #81c784, #fff176, #e57373); height: 100%; width: 0%; transition: width 1.5s ease-in-out; }
        .gdd-label { position: absolute; width: 100%; text-align: center; font-size: 10px; font-weight: bold; line-height: 18px; color: #333; }

        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin: 20px 0; display: none; }
        .stat { background: #fdf5e6; padding: 15px; border-radius: 10px; text-align: center; border: 1px solid #d7ccc8; }
        .stat label { display: block; font-size: 10px; font-weight: 800; color: #6d4c41; text-transform: uppercase; margin-bottom: 5px; }
        .stat span { font-size: 22px; font-weight: bold; color: #3e2723; }
        
        .forecast { width: 100%; border-collapse: collapse; margin-top: 20px; display: none; }
        .forecast th, .forecast td { padding: 12px; border-bottom: 1px solid #efebe9; text-align: center; font-size: 14px; }
        .badge { padding: 4px 8px; border-radius: 4px; font-weight: bold; font-size: 11px; }
        .run { background: #e8f5e9; color: #2e7d32; }
        .risk { background: #ffebee; color: #c62828; }
        .loader { text-align: center; padding: 20px; color: #5d4037; font-weight: bold; display: none; }
    </style>
</head>
<body>

<div class="card">
    <h1>Sugarbush Signal</h1>
    <div class="subtitle">Precision Boiling & Tree Vitality Intelligence</div>
    
    <div id="trivia" class="trivia-box">Stoking the fire...</div>

    <div class="input-group">
        <input type="text" id="zipInput" placeholder="Enter Zip Code" maxlength="5">
        <button onclick="runAnalysis()">Analyze Bush</button>
    </div>

    <div id="loader" class="loader">ðŸ“¡ Syncing with Weather Grid...</div>

    <div id="gddWrapper">
        <label style="font-size: 11px; font-weight: 800; color: #6d4c41;">SEASON VITALITY (GDD BASE 40)</label>
        <div class="gdd-container">
            <div id="gddBar" class="gdd-bar"></div>
            <div id="gddLabel" class="gdd-label">0 GDD Accumulated</div>
        </div>
        <div id="seasonAdvice" style="font-size: 12px; margin-top: 8px; color: #4e342e; font-weight: 500;"></div>
    </div>

    <div id="dashboard" class="grid">
        <div class="stat"><label>Grid Elevation</label><span id="val-elev">--</span></div>
        <div class="stat"><label>Water Boils At</label><span id="val-water">--</span></div>
        <div class="stat" style="border: 2px solid #8d6e63;"><label>Finish Syrup At</label><span id="val-syrup" style="color:#4e342e;">--</span></div>
    </div>

    <table id="forecastTable" class="forecast">
        <thead>
            <tr><th>Day</th><th>High / Low</th><th>Sap Flow</th><th>Safety</th></tr>
        </thead>
        <tbody id="forecastBody"></tbody>
    </table>
</div>

<script>
    const facts = [
        "A standard tap hole is only about 1.5 to 2 inches deep.",
        "Freezing nights create negative pressure, sucking water into the roots.",
        "Thawing days create positive pressure, pushing sap out of the tap.",
        "Sugar concentration is usually highest at the very beginning of the season.",
        "Birch trees can also be tapped, but their ratio is often 100:1 for syrup.",
        "Maples are 'diffuse-porous' trees, which is why they respond so well to pressure changes."
    ];

    window.onload = () => {
        document.getElementById('trivia').innerText = "Sugarbush Trivia: " + facts[Math.floor(Math.random() * facts.length)];
    };

    async function runAnalysis() {
        const zip = document.getElementById('zipInput').value;
        const loader = document.getElementById('loader');
        if (!/^\d{5}$/.test(zip)) return alert("Please enter a valid ZIP.");

        loader.style.display = 'block';

        try {
            const zipRes = await fetch(`https://api.zippopotam.us/us/${zip}`);
            const zipData = await zipRes.json();
            const lat = zipData.places[0].latitude;
            const lon = zipData.places[0].longitude;

            const nwsPointsRes = await fetch(`https://api.weather.gov/points/${lat},${lon}`);
            const pointsData = await nwsPointsRes.json();
            
            const gridRes = await fetch(pointsData.properties.forecastGridData);
            const gridData = await gridRes.json();
            const elevFt = gridData.properties.elevation.value * 3.28084;

            const forecastRes = await fetch(pointsData.properties.forecast);
            const forecastData = await forecastRes.json();

            const waterBoil = 212 - (elevFt / 500);
            const syrupFinish = waterBoil + 7.1;

            document.getElementById('val-elev').innerText = Math.round(elevFt) + " ft";
            document.getElementById('val-water').innerText = waterBoil.toFixed(1) + "Â°F";
            document.getElementById('val-syrup').innerText = syrupFinish.toFixed(1) + "Â°F";

            try {
                const now = new Date();
                const start = new Date(now.getFullYear(), 0, 1);
                const diffDays = Math.ceil((now - start) / (1000 * 60 * 60 * 24));
                const gddUrl = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&daily=temperature_2m_max,temperature_2m_min&past_days=${diffDays}&timezone=auto&temperature_unit=fahrenheit`;
                const gddRes = await fetch(gddUrl);
                const gddData = await gddRes.json();

                let totalGDD = 0;
                for (let i = 0; i < gddData.daily.time.length; i++) {
                    const high = gddData.daily.temperature_2m_max[i];
                    const low = gddData.daily.temperature_2m_min[i];
                    if (high !== null && low !== null) {
                        totalGDD += Math.max(((high + low) / 2) - 40, 0);
                    }
                }

                document.getElementById('gddWrapper').style.display = 'block';
                const percent = Math.min((totalGDD / 150) * 100, 100);
                document.getElementById('gddBar').style.width = percent + "%";
                document.getElementById('gddLabel').innerText = Math.round(totalGDD) + " GDD Units";
                
                let advice = "ðŸŒ³ Buds are tight and dormant.";
                if (totalGDD > 70) advice = "ðŸŸ¡ Trees are waking up. Quality is still good.";
                if (totalGDD > 120) advice = "ðŸš¨ Warning: Bud swell likely. 'Buddy' sap season near.";
                document.getElementById('seasonAdvice').innerText = advice;
            } catch (e) { console.log("GDD Bypass"); }

            const tbody = document.getElementById('forecastBody');
            tbody.innerHTML = '';
            const periods = forecastData.properties.periods;
            for (let i = 0; i < periods.length; i += 2) {
                const day = periods[i]; const night = periods[i+1];
                if (!night) break;
                const isRun = (night.temperature < 32 && day.temperature > 34);
                const isRisk = (day.temperature > 45 || night.temperature > 38);
                tbody.innerHTML += `<tr><td>${day.name}</td><td><strong>${day.temperature}Â°</strong> / ${night.temperature}Â°</td><td>${isRun ? '<span class="badge run">RUNNING</span>' : '--'}</td><td>${isRisk ? '<span class="badge risk">BOIL NOW</span>' : 'âœ… SAFE'}</td></tr>`;
            }

            document.getElementById('dashboard').style.display = 'grid';
            document.getElementById('forecastTable').style.display = 'table';
            loader.style.display = 'none';

        } catch (err) {
            loader.style.display = 'none';
            alert("Connection error with government weather grid.");
        }
    }
</script>
</body>
</html>
