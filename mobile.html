<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sugarbush Signal | Mobile Pro</title>

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Sugarbush">
    <link rel="apple-touch-icon" href="icon.png">
    <link rel="icon" type="image/png" href="icon.png">
    <link rel="manifest" href="manifest.json">

    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        body { background-color: #fcf8f2; -webkit-tap-highlight-color: transparent; }
        .maple-gradient { background: linear-gradient(90deg, #81c784, #fff176, #e57373); }
        .tap-active:active { transform: scale(0.96); transition: transform 0.1s; }
        .hide-scroll::-webkit-scrollbar { display: none; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        const triviaList = [
            "It takes roughly 40 gallons of sap to make 1 gallon of syrup.",
            "Maple hydrometers are usually calibrated at 60Â°F or 211Â°F.",
            "Sap pressure is highest during the thaw after a hard freeze.",
            "Sugar maples are the most popular for tapping due to sugar density.",
            "Once buds swell, sap turns 'buddy' and the season is over.",
            "RO (Reverse Osmosis) can remove 75% of water before boiling."
        ];

        // --- SUB-COMPONENT: BRIX CORRECTOR ---
        function BrixLab() {
            const [obs, setObs] = useState(66);
            const [temp, setTemp] = useState(211);
            const [cal, setCal] = useState(211);
            const corrected = (parseFloat(obs) + (temp - cal) * 0.047).toFixed(1);

            return (
                <div className="bg-white p-5 rounded-3xl shadow-sm border border-amber-100 mt-6">
                    <h3 className="text-xs font-black text-amber-900 mb-3 uppercase tracking-wider">Brix Correction Lab</h3>
                    <div className="grid grid-cols-2 gap-3 mb-4">
                        <div className="col-span-2">
                            <label className="text-[10px] font-bold text-gray-400 uppercase">Observed Brix (%)</label>
                            <input type="number" value={obs} onChange={e=>setObs(e.target.value)} className="w-full p-3 bg-amber-50 rounded-xl text-lg font-bold outline-none border-2 border-transparent focus:border-amber-200" />
                        </div>
                        <div>
                            <label className="text-[10px] font-bold text-gray-400 uppercase">Syrup Temp Â°F</label>
                            <input type="number" value={temp} onChange={e=>setTemp(e.target.value)} className="w-full p-3 bg-amber-50 rounded-xl text-lg font-bold outline-none" />
                        </div>
                        <div>
                            <label className="text-[10px] font-bold text-gray-400 uppercase">Hydrometer Cal</label>
                            <select value={cal} onChange={e=>setCal(e.target.value)} className="w-full p-3 bg-amber-50 rounded-xl text-sm font-bold h-[52px]">
                                <option value="211">Hot (211Â°)</option>
                                <option value="60">Cold (60Â°)</option>
                            </select>
                        </div>
                    </div>
                    <div className="bg-orange-50 p-4 rounded-2xl text-center border border-orange-100">
                        <span className="text-[10px] font-black text-orange-800 block uppercase">True Brix Result</span>
                        <span className="text-4xl font-black text-orange-600">{corrected}%</span>
                    </div>
                </div>
            );
        }

        function SugarbushApp() {
            const [zip, setZip] = useState('');
            const [data, setData] = useState(null);
            const [loading, setLoading] = useState(false);
            const [trivia, setTrivia] = useState('');

            useEffect(() => {
                setTrivia(triviaList[Math.floor(Math.random() * triviaList.length)]);
            }, []);

            async function analyze() {
                if (!/^\d{5}$/.test(zip)) return alert("Invalid Zip");
                setLoading(true);
                try {
                    const zRes = await fetch(`https://api.zippopotam.us/us/${zip}`);
                    const zData = await zRes.json();
                    const { latitude: lat, longitude: lon } = zData.places[0];

                    // 1. NWS Data
                    const pRes = await fetch(`https://api.weather.gov/points/${lat},${lon}`);
                    const pData = await pRes.json();
                    const gRes = await fetch(pData.properties.forecastGridData);
                    const gridData = await gRes.json();
                    const elev = gridData.properties.elevation.value * 3.28084;
                    const fRes = await fetch(pData.properties.forecast);
                    const fData = await fRes.json();

                    // 2. Open-Meteo (Pressure & GDD History)
                    const now = new Date();
                    const diffDays = Math.ceil((now - new Date(now.getFullYear(), 0, 1)) / 86400000);
                    const omRes = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=surface_pressure&daily=temperature_2m_max,temperature_2m_min&past_days=${diffDays}&timezone=auto&temperature_unit=fahrenheit`);
                    const omData = await omRes.json();

                    // BP Logic (Pressure Adjusted)
                    const pressInHg = omData.current.surface_pressure * 0.02953;
                    const liveWaterBP = 212 + (pressInHg - 29.92) * 1.73;

                    // GDD Logic (Base 40)
                    let totalGDD = 0;
                    omData.daily.time.forEach((_, i) => {
                        const avg = (omData.daily.temperature_2m_max[i] + omData.daily.temperature_2m_min[i]) / 2;
                        totalGDD += Math.max(avg - 40, 0);
                    });

                    setData({
                        elev: Math.round(elev),
                        press: pressInHg.toFixed(2),
                        waterBP: liveWaterBP.toFixed(1),
                        syrupBP: (liveWaterBP + 7.1).toFixed(1),
                        gdd: Math.round(totalGDD),
                        forecast: fData.properties.periods.filter((_, i) => i % 2 === 0).map((d, i) => ({
                            name: d.name,
                            high: d.temperature,
                            low: fData.properties.periods[i*2+1]?.temperature || '--',
                            isRun: (fData.properties.periods[i*2+1]?.temperature < 32 && d.temperature > 34),
                            isRisk: (d.temperature > 45)
                        }))
                    });
                } catch (e) { alert("Weather Grid Offline"); }
                setLoading(false);
            }

            return (
                <div className="max-w-md mx-auto p-4 pb-12">
                    <header className="text-center py-6">
                        <h1 className="text-3xl font-black text-amber-900 tracking-tighter">Sugarbush Signal</h1>
                        <p className="text-[10px] font-black text-amber-700 uppercase tracking-widest">Live Season Intelligence</p>
                    </header>

                    <div className="bg-white p-4 rounded-3xl shadow-sm mb-6 border-l-8 border-amber-600 italic text-sm text-amber-900">
                        "{trivia}"
                    </div>

                    <div className="flex gap-2 mb-8">
                        <input type="tel" value={zip} onChange={e=>setZip(e.target.value)} placeholder="Zip Code" className="flex-1 p-4 rounded-2xl border-2 border-amber-100 shadow-inner text-lg font-bold focus:border-amber-400 outline-none" />
                        <button onClick={analyze} className="tap-active bg-amber-900 text-white px-8 py-4 rounded-2xl font-black shadow-lg">
                            {loading ? '...' : 'GO'}
                        </button>
                    </div>

                    {data && (
                        <div className="animate-in fade-in slide-in-from-bottom-4 duration-500">
                            {/* Live Vitality */}
                            <div className="bg-white p-5 rounded-3xl shadow-sm border border-amber-100 mb-4">
                                <div className="flex justify-between items-end mb-2">
                                    <label className="text-[10px] font-black text-amber-800 uppercase">Season Vitality</label>
                                    <span className="text-xs font-bold text-amber-600">{data.gdd} GDD Accumulated</span>
                                </div>
                                <div className="w-full bg-gray-100 h-5 rounded-full overflow-hidden">
                                    <div className="maple-gradient h-full transition-all duration-1000" style={{width: `${Math.min((data.gdd/150)*100, 100)}%`}}></div>
                                </div>
                                <p className="text-[10px] text-gray-400 mt-2 font-bold uppercase text-center">
                                    {data.gdd < 100 ? "ðŸŒ³ Dormant / Prime" : "ðŸš¨ Bud Swell Imminent"}
                                </p>
                            </div>

                            {/* Boiling Dashboard */}
                            <div className="grid grid-cols-2 gap-3 mb-4">
                                <div className="bg-white p-4 rounded-3xl border border-amber-100 text-center">
                                    <label className="block text-[10px] font-bold text-gray-400 uppercase">Baro Pressure</label>
                                    <span className="text-xl font-black text-amber-900">{data.press}"</span>
                                </div>
                                <div className="bg-white p-4 rounded-3xl border border-amber-100 text-center">
                                    <label className="block text-[10px] font-bold text-gray-400 uppercase">Elevation</label>
                                    <span className="text-xl font-black text-amber-900">{data.elev}'</span>
                                </div>
                                <div className="bg-amber-100 p-5 rounded-3xl text-center">
                                    <label className="block text-[10px] font-bold text-amber-800 uppercase">Water Boils</label>
                                    <span className="text-2xl font-black text-amber-900">{data.waterBP}Â°</span>
                                </div>
                                <div className="bg-orange-600 p-5 rounded-3xl text-center text-white ring-8 ring-orange-50">
                                    <label className="block text-[10px] font-bold opacity-80 uppercase">Finish Syrup</label>
                                    <span className="text-2xl font-black">{data.syrupBP}Â°</span>
                                </div>
                            </div>

                            {/* Forecast List */}
                            <div className="bg-white rounded-3xl shadow-sm overflow-hidden mb-6">
                                {data.forecast.map((day, i) => (
                                    <div key={i} className="flex items-center justify-between p-4 border-b border-amber-50 last:border-0">
                                        <span className="font-bold text-sm w-16">{day.name.slice(0,3)}</span>
                                        <div className="flex-1 text-center">
                                            <span className="font-black text-lg text-amber-900">{day.high}Â°</span>
                                            <span className="text-xs text-gray-300 ml-1">/{day.low}Â°</span>
                                        </div>
                                        <div className="flex gap-1 justify-end w-24">
                                            {day.isRun && <span className="bg-green-100 text-green-700 text-[9px] font-black px-2 py-1 rounded uppercase">Run</span>}
                                            {day.isRisk && <span className="bg-red-50 text-red-600 text-[9px] font-black px-2 py-1 rounded uppercase">Risk</span>}
                                        </div>
                                    </div>
                                ))}
                            </div>

                            <BrixLab />
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<SugarbushApp />);
    </script>
</body>
</html>
