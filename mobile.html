<!DOCTYPE html>
<html lang="en">
<head>
    <title>Sugarbush Signal | Mobile</title>

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="maple.png">
    <link rel="icon" type="image/png" href="icon.png">
    </head>

<link rel="apple-touch-icon" href="maple.png">
<link rel="icon" type="image/png" href="maple.png">

<link rel="manifest" href="manifest.json">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sugarbush Signal | Mobile</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #fcf8f2; }
        .maple-gradient { background: linear-gradient(90deg, #81c784, #fff176, #e57373); }
        .tap-button { background-color: #5d4037; }
        .tap-button:active { transform: scale(0.95); }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        const facts = [
            "A standard tap hole is only about 1.5 to 2 inches deep.",
            "Freezing nights create negative pressure, sucking water into the roots.",
            "Thawing days create positive pressure, pushing sap out of the tap.",
            "Sugar concentration is usually highest at the very beginning of the season.",
            "Birch trees can also be tapped, but their ratio is often 100:1 for syrup.",
            "Maples are 'diffuse-porous' trees, which is why they respond so well to pressure."
        ];

        function SugarbushApp() {
            const [zip, setZip] = useState('');
            const [data, setData] = useState(null);
            const [loading, setLoading] = useState(false);
            const [trivia, setTrivia] = useState('');

            useEffect(() => {
                setTrivia(facts[Math.floor(Math.random() * facts.length)]);
            }, []);

            async function analyzeBush() {
                if (!/^\d{5}$/.test(zip)) return alert("Enter 5-digit ZIP");
                setLoading(true);
                try {
                    // 1. Geocoding
                    const zRes = await fetch(`https://api.zippopotam.us/us/${zip}`);
                    const zData = await zRes.json();
                    const { latitude: lat, longitude: lon } = zData.places[0];

                    // 2. NWS Core Data
                    const pRes = await fetch(`https://api.weather.gov/points/${lat},${lon}`);
                    const pData = await pRes.json();
                    
                    const gRes = await fetch(pData.properties.forecastGridData);
                    const gData = await gRes.json();
                    const elev = gData.properties.elevation.value * 3.28084;

                    const fRes = await fetch(pData.properties.forecast);
                    const fData = await fRes.json();

                    // 3. GDD History (Open-Meteo)
                    const now = new Date();
                    const start = new Date(now.getFullYear(), 0, 1);
                    const diffDays = Math.ceil((now - start) / (1000 * 60 * 60 * 24));
                    const gddUrl = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&daily=temperature_2m_max,temperature_2m_min&past_days=${diffDays}&timezone=auto&temperature_unit=fahrenheit`;
                    const gddRes = await fetch(gddUrl);
                    const gddData = await gddRes.json();

                    let totalGDD = 0;
                    gddData.daily.time.forEach((_, i) => {
                        const avg = (gddData.daily.temperature_2m_max[i] + gddData.daily.temperature_2m_min[i]) / 2;
                        totalGDD += Math.max(avg - 40, 0);
                    });

                    // Physics
                    const waterBP = 212 - (elev / 500);

                    setData({
                        elev: Math.round(elev),
                        waterBP: waterBP.toFixed(1),
                        syrupBP: (waterBP + 7.1).toFixed(1),
                        gdd: Math.round(totalGDD),
                        forecast: fData.properties.periods.filter((_, i) => i % 2 === 0).map((day, i) => ({
                            name: day.name,
                            high: day.temperature,
                            low: fData.properties.periods[i*2 + 1]?.temperature || '--',
                            isRun: (fData.properties.periods[i*2 + 1]?.temperature < 32 && day.temperature > 34),
                            isRisk: (day.temperature > 45)
                        }))
                    });
                } catch (err) {
                    alert("Weather Grid Offline. Try again.");
                }
                setLoading(false);
            }

            return (
                <div className="max-w-md mx-auto p-4 min-h-screen">
                    <header className="text-center mb-6">
                        <h1 className="text-3xl font-black text-amber-900 leading-tight">Sugarbush Signal</h1>
                        <p className="text-xs font-bold text-amber-700 tracking-widest uppercase">Mobile Intelligence</p>
                    </header>

                    <div className="bg-amber-50 border-l-4 border-amber-600 p-4 mb-6 rounded shadow-sm italic text-sm text-amber-900">
                        "{trivia}"
                    </div>

                    <div className="flex gap-2 mb-8">
                        <input 
                            type="tel" 
                            className="flex-1 p-4 rounded-xl border-2 border-amber-200 shadow-inner text-lg" 
                            placeholder="Zip Code"
                            value={zip}
                            onChange={(e) => setZip(e.target.value)}
                        />
                        <button 
                            onClick={analyzeBush}
                            className="tap-button text-white px-6 py-4 rounded-xl font-bold shadow-lg"
                        >
                            {loading ? '...' : 'GO'}
                        </button>
                    </div>

                    {data && (
                        <div className="space-y-4 animate-in fade-in duration-500">
                            {/* GDD Tracker */}
                            <div className="bg-white p-4 rounded-2xl shadow-sm border border-amber-100">
                                <label className="text-[10px] font-black text-amber-800 uppercase">Season Vitality</label>
                                <div className="w-full bg-gray-200 h-4 rounded-full mt-2 overflow-hidden relative">
                                    <div className="maple-gradient h-full transition-all duration-1000" style={{width: `${(data.gdd/150)*100}%`}}></div>
                                    <span className="absolute inset-0 text-[10px] text-center font-bold leading-4">{data.gdd} GDD</span>
                                </div>
                            </div>

                            {/* Boiling Stats */}
                            <div className="grid grid-cols-2 gap-3">
                                <div className="bg-amber-100 p-4 rounded-2xl text-center">
                                    <label className="block text-[10px] font-bold text-amber-800">WATER BOILS</label>
                                    <span className="text-xl font-black">{data.waterBP}째</span>
                                </div>
                                <div className="bg-orange-600 p-4 rounded-2xl text-center text-white ring-4 ring-orange-100">
                                    <label className="block text-[10px] font-bold opacity-80">FINISH SYRUP</label>
                                    <span className="text-xl font-black">{data.syrupBP}째</span>
                                </div>
                            </div>

                            {/* Mobile Forecast List */}
                            <div className="bg-white rounded-2xl shadow-sm overflow-hidden">
                                {data.forecast.map((day, i) => (
                                    <div key={i} className="flex items-center justify-between p-4 border-b border-amber-50 last:border-0">
                                        <div className="w-1/4">
                                            <span className="font-bold text-sm">{day.name.slice(0,3)}</span>
                                        </div>
                                        <div className="w-1/4 text-center">
                                            <span className="font-black text-lg text-amber-900">{day.high}째</span>
                                            <span className="text-xs text-gray-400 ml-1">/{day.low}째</span>
                                        </div>
                                        <div className="w-2/4 text-right">
                                            {day.isRun && <span className="bg-green-100 text-green-700 text-[10px] font-black px-2 py-1 rounded-md mr-1 uppercase">Run</span>}
                                            {day.isRisk && <span className="bg-red-100 text-red-700 text-[10px] font-black px-2 py-1 rounded-md uppercase">Boil</span>}
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<SugarbushApp />);
    </script>
</body>
</html>
