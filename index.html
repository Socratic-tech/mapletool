<!doctype html>
<html lang="en">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sugarbush Signal | Web Edition</title>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
body { background-color:#fcf8f2; -webkit-tap-highlight-color:transparent; box-sizing: border-box; }
.maple-gradient { background:linear-gradient(90deg,#81c784,#fff176,#e57373); }
.tap-active:active { transform:scale(0.98); transition:transform 0.1s; }

@keyframes spin {
to { transform:rotate(360deg); }
}

.spinner {
display:inline-block;
width:18px;
height:18px;
border:3px solid rgba(255,255,255,0.3);
border-top-color:#fff;
border-radius:50%;
animation:spin 0.8s linear infinite;
}

.error-shake {
animation: shake 0.3s;
}

@keyframes shake {
0%, 100% { transform: translateX(0); }
25% { transform: translateX(-10px); }
75% { transform: translateX(10px); }
}

.fade-in {
animation: fadeIn 0.3s ease-in;
}

@keyframes fadeIn {
from { opacity: 0; transform: translateY(-10px); }
to { opacity: 1; transform: translateY(0); }
}

.grade-golden { background: linear-gradient(135deg, #f9d87a 0%, #f4c430 100%); }
.grade-amber { background: linear-gradient(135deg, #e8a54f 0%, #d68910 100%); }
.grade-dark { background: linear-gradient(135deg, #8b4513 0%, #5c2e0a 100%); }
.grade-very-dark { background: linear-gradient(135deg, #3e2723 0%, #1a0f0a 100%); }
</style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
  <script src="/_sdk/element_sdk.js" type="text/javascript"></script>
 </head>
 <body>
  <div id="root"></div>
  <script type="text/babel">
// Mobile device detection and redirect
(function() {
  const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
  const isSmallScreen = window.innerWidth < 768;
  
  if (isMobile || isSmallScreen) {
    window.location.href = 'mobile.html';
  }
})();

const { useState, useEffect, useRef } = React;

const triviaList = [
"It takes roughly 40 gallons of sap to make 1 gallon of syrup.",
"Maple hydrometers are usually calibrated at 60Â°F or 211Â°F.",
"Sap pressure is highest during the thaw after a hard freeze.",
"Sugar maples are the most popular for tapping due to sugar density.",
"Once buds swell, sap turns 'buddy' and the season is over.",
"RO (Reverse Osmosis) can remove 75% of water before boiling.",
"The boiling point of water drops about 1Â°F for every 500 feet of elevation gain.",
"Sugar maples can produce sap for over 100 years when properly tapped.",
"The Indigenous peoples of North America were the first to discover maple sugaring.",
"Maple syrup season typically lasts 4-6 weeks in late winter and early spring."
];

function predictGrade(gdd) {
if (gdd < 30) return { grade: "Golden Delicate", color: "grade-golden", desc: "Light, delicate flavor" };
if (gdd < 60) return { grade: "Amber Rich", color: "grade-amber", desc: "Rich, full-bodied flavor" };
if (gdd < 100) return { grade: "Dark Robust", color: "grade-dark", desc: "Robust, caramel notes" };
return { grade: "Very Dark Strong", color: "grade-very-dark", desc: "Strong, intense flavor" };
}

function AdvancedProductionCalc({ data }) {
const [tapCount, setTapCount] = useState(100);
const [avgSapPerTap, setAvgSapPerTap] = useState(10);
const [sugarContent, setSugarContent] = useState(2);
const [roConcentration, setRoConcentration] = useState(8);
const [fuelCost, setFuelCost] = useState(3.5);
const [fuelType, setFuelType] = useState('wood');
const [evapRate, setEvapRate] = useState(25);

const goodRunDays = data.forecast.filter(d => d.isRun).length;
const totalSap = tapCount * avgSapPerTap * goodRunDays;
const syrupYield = (totalSap * sugarContent) / 66.9;
const waterToRemove = totalSap * (1 - roConcentration / 100);
const boilTime = waterToRemove / evapRate;
const fuelNeeded = fuelType === 'wood' ? boilTime * 15 : fuelType === 'oil' ? boilTime * 0.8 : boilTime * 1.2;
const fuelCostTotal = fuelNeeded * fuelCost;
const valueAtWholesale = syrupYield * 45;

return (
<div className="bg-gradient-to-br from-indigo-50 to-purple-50 p-6 rounded-3xl shadow-lg border border-indigo-200">
<h3 className="text-sm font-black text-indigo-900 uppercase tracking-wider mb-4">
ğŸ›ï¸ Production Calculator
</h3>

<div className="grid md:grid-cols-2 gap-6">
<div className="bg-white p-5 rounded-2xl">
<h4 className="text-xs font-bold text-indigo-700 uppercase mb-4">âš™ï¸ Setup Parameters</h4>
<div className="space-y-3">
<div>
<label htmlFor="tapCount" className="text-[10px] font-bold text-gray-500 uppercase block mb-1">Number of Taps</label>
<input
id="tapCount"
type="number"
value={tapCount}
onChange={e => setTapCount(Number(e.target.value))}
className="w-full p-3 bg-indigo-50 rounded-lg text-sm font-bold outline-none border-2 border-transparent focus:border-indigo-300"
/>
</div>
<div>
<label htmlFor="avgSapPerTap" className="text-[10px] font-bold text-gray-500 uppercase block mb-1">Sap per Tap per Day (gallons)</label>
<input
id="avgSapPerTap"
type="number"
step="0.5"
value={avgSapPerTap}
onChange={e => setAvgSapPerTap(Number(e.target.value))}
className="w-full p-3 bg-indigo-50 rounded-lg text-sm font-bold outline-none border-2 border-transparent focus:border-indigo-300"
/>
</div>
<div>
<label htmlFor="sugarContent" className="text-[10px] font-bold text-gray-500 uppercase block mb-1">Sap Sugar Content % (Brix)</label>
<input
id="sugarContent"
type="number"
step="0.1"
value={sugarContent}
onChange={e => setSugarContent(Number(e.target.value))}
className="w-full p-3 bg-indigo-50 rounded-lg text-sm font-bold outline-none border-2 border-transparent focus:border-indigo-300"
/>
</div>
<div>
<label htmlFor="roConcentration" className="text-[10px] font-bold text-gray-500 uppercase block mb-1">RO Concentration %</label>
<input
id="roConcentration"
type="number"
value={roConcentration}
onChange={e => setRoConcentration(Number(e.target.value))}
className="w-full p-3 bg-indigo-50 rounded-lg text-sm font-bold outline-none border-2 border-transparent focus:border-indigo-300"
/>
</div>
<div>
<label htmlFor="evapRate" className="text-[10px] font-bold text-gray-500 uppercase block mb-1">Evaporator Rate (gal/hr)</label>
<input
id="evapRate"
type="number"
value={evapRate}
onChange={e => setEvapRate(Number(e.target.value))}
className="w-full p-3 bg-indigo-50 rounded-lg text-sm font-bold outline-none border-2 border-transparent focus:border-indigo-300"
/>
</div>
<div className="grid grid-cols-2 gap-3">
<div>
<label htmlFor="fuelType" className="text-[10px] font-bold text-gray-500 uppercase block mb-1">Fuel Type</label>
<select
id="fuelType"
value={fuelType}
onChange={e => setFuelType(e.target.value)}
className="w-full p-3 bg-indigo-50 rounded-lg text-sm font-bold h-[44px]"
>
<option value="wood">Wood</option>
<option value="oil">Oil</option>
<option value="propane">Propane</option>
</select>
</div>
<div>
<label htmlFor="fuelCost" className="text-[10px] font-bold text-gray-500 uppercase block mb-1">
{fuelType === 'wood' ? 'Cost/Cord' : fuelType === 'oil' ? 'Cost/Gal' : 'Cost/Lb'}
</label>
<input
id="fuelCost"
type="number"
step="0.1"
value={fuelCost}
onChange={e => setFuelCost(Number(e.target.value))}
className="w-full p-3 bg-indigo-50 rounded-lg text-sm font-bold outline-none border-2 border-transparent focus:border-indigo-300"
/>
</div>
</div>
</div>
</div>

<div className="space-y-4">
<div className="bg-gradient-to-br from-green-400 to-emerald-500 p-6 rounded-2xl text-white shadow-lg">
<div className="text-xs font-bold opacity-90 uppercase mb-3">ï¿½ï¿½ï¿½ 7-Day Production Forecast</div>
<div className="grid grid-cols-2 gap-6">
<div>
<div className="text-sm opacity-90 mb-1">Total Sap Collection</div>
<div className="text-3xl font-black">{totalSap.toFixed(0)} gal</div>
</div>
<div>
<div className="text-sm opacity-90 mb-1">Expected Syrup Yield</div>
<div className="text-3xl font-black">{syrupYield.toFixed(1)} gal</div>
</div>
</div>
</div>

<div className="grid grid-cols-3 gap-3">
<div className="bg-white p-4 rounded-2xl text-center border border-indigo-100">
<div className="text-[9px] font-bold text-gray-500 uppercase">Boil Time</div>
<div className="text-xl font-black text-indigo-900">{boilTime.toFixed(1)} hrs</div>
</div>
<div className="bg-white p-4 rounded-2xl text-center border border-indigo-100">
<div className="text-[9px] font-bold text-gray-500 uppercase">Run Days</div>
<div className="text-xl font-black text-indigo-900">{goodRunDays}</div>
</div>
<div className="bg-white p-4 rounded-2xl text-center border border-indigo-100">
<div className="text-[9px] font-bold text-gray-500 uppercase">Sap:Syrup</div>
<div className="text-xl font-black text-indigo-900">{(totalSap / syrupYield).toFixed(0)}:1</div>
</div>
</div>

<div className="bg-white p-5 rounded-2xl border-2 border-orange-200">
<div className="text-xs font-bold text-orange-700 uppercase mb-3">ğŸ’° Economics Analysis</div>
<div className="space-y-2">
<div className="flex justify-between items-center">
<span className="text-sm text-gray-600">Fuel Needed:</span>
<span className="font-bold text-gray-900">
{fuelNeeded.toFixed(1)} {fuelType === 'wood' ? 'cords' : fuelType === 'oil' ? 'gal' : 'lbs'}
</span>
</div>
<div className="flex justify-between items-center">
<span className="text-sm text-gray-600">Fuel Cost:</span>
<span className="font-bold text-red-600">${fuelCostTotal.toFixed(2)}</span>
</div>
<div className="flex justify-between items-center border-t border-gray-200 pt-2">
<span className="text-sm text-gray-600">Wholesale Value ($45/gal):</span>
<span className="font-bold text-green-600">${valueAtWholesale.toFixed(2)}</span>
</div>
<div className="flex justify-between items-center border-t-2 border-indigo-200 pt-3">
<span className="font-bold text-gray-900">Net Profit Margin:</span>
<span className="font-black text-xl text-indigo-900">
${(valueAtWholesale - fuelCostTotal).toFixed(2)}
</span>
</div>
<div className="flex justify-between items-center text-xs bg-indigo-50 p-2 rounded-lg mt-2">
<span className="text-indigo-700">Cost per Gallon:</span>
<span className="font-bold text-indigo-900">${(fuelCostTotal / syrupYield).toFixed(2)}</span>
</div>
<div className="flex justify-between items-center text-xs bg-indigo-50 p-2 rounded-lg">
<span className="text-indigo-700">Profit per Tap:</span>
<span className="font-bold text-indigo-900">${((valueAtWholesale - fuelCostTotal) / tapCount).toFixed(2)}</span>
</div>
</div>
</div>
</div>
</div>
</div>
);
}

function GradingAssistant({ gdd }) {
const [showHelp, setShowHelp] = useState(false);
const prediction = predictGrade(gdd);

return (
<div className="bg-white p-5 rounded-3xl shadow-sm border border-purple-100">
<div className="flex items-center justify-between mb-3">
<h3 className="text-xs font-black text-purple-900 uppercase tracking-wider">
ğŸ§ª Syrup Grade Predictor
</h3>
<button 
onClick={() => setShowHelp(!showHelp)}
className="w-7 h-7 rounded-full bg-purple-100 text-purple-900 font-black text-sm hover:bg-purple-200 transition-colors"
aria-label="Toggle grading help"
>
?
</button>
</div>

{showHelp && (
<div className="mb-4 p-4 bg-purple-50 border-l-4 border-purple-400 rounded-lg text-sm fade-in">
<p className="font-bold text-purple-900 mb-2">ğŸ“˜ Grade Guide:</p>
<div className="space-y-2 text-xs">
<div className="flex items-center gap-2">
<div className="w-6 h-6 rounded grade-golden border border-yellow-600"></div>
<span className="text-purple-800"><strong>Golden:</strong> Early season, light color, delicate taste</span>
</div>
<div className="flex items-center gap-2">
<div className="w-6 h-6 rounded grade-amber border border-orange-600"></div>
<span className="text-purple-800"><strong>Amber:</strong> Mid-season, rich flavor, full-bodied</span>
</div>
<div className="flex items-center gap-2">
<div className="w-6 h-6 rounded grade-dark border border-amber-900"></div>
<span className="text-purple-800"><strong>Dark:</strong> Late season, robust caramel notes</span>
</div>
<div className="flex items-center gap-2">
<div className="w-6 h-6 rounded grade-very-dark border border-gray-900"></div>
<span className="text-purple-800"><strong>Very Dark:</strong> End season, strong intense flavor</span>
</div>
</div>
<p className="text-purple-700 mt-3 text-xs italic">
ğŸ’¡ Grade depends on when sap is collected. More GDD = darker syrup!
</p>
</div>
)}

<div className="flex items-center gap-4 mb-3">
<div className={`w-16 h-16 rounded-xl ${prediction.color} border-2 border-gray-300 shadow-inner`}></div>
<div className="flex-1">
<div className="text-lg font-black text-purple-900">{prediction.grade}</div>
<div className="text-xs text-gray-600">{prediction.desc}</div>
</div>
</div>

<div className="bg-purple-50 p-3 rounded-xl text-center">
<span className="text-[10px] font-bold text-purple-700 uppercase block mb-1">
Current Season Progress
</span>
<div className="w-full h-3 bg-gray-200 rounded-full overflow-hidden">
<div 
className="h-full transition-all duration-1000"
style={{
width: `${Math.min((gdd / 150) * 100, 100)}%`,
background: 'linear-gradient(90deg, #f9d87a, #e8a54f, #8b4513, #3e2723)'
}}
></div>
</div>
<span className="text-[9px] text-gray-500 mt-1 block">
{gdd < 30 ? 'Early Season - Expect Golden' : gdd < 60 ? 'Mid Season - Expect Amber' : gdd < 100 ? 'Late Season - Expect Dark' : 'Season End - Expect Very Dark'}
</span>
</div>
</div>
);
}

function RunPredictor({ forecast }) {
const runWindows = [];
let currentWindow = [];
  
forecast.forEach((day, idx) => {
if (day.isRun) {
currentWindow.push({ ...day, index: idx });
} else {
if (currentWindow.length >= 2) {
runWindows.push([...currentWindow]);
}
currentWindow = [];
}
});
if (currentWindow.length >= 2) {
runWindows.push(currentWindow);
}

let best3Day = null;
let maxScore = 0;
for (let i = 0; i <= forecast.length - 3; i++) {
const window = forecast.slice(i, i + 3);
const score = window.filter(d => d.isRun).length;
if (score > maxScore) {
maxScore = score;
best3Day = { start: forecast[i].name, days: window, score };
}
}

const shouldFire = runWindows.some(w => w.length >= 2) || (best3Day && best3Day.score >= 2);

return (
<div className="bg-gradient-to-br from-green-50 to-emerald-50 p-5 rounded-3xl shadow-sm border border-green-200">
<h3 className="text-xs font-black text-green-900 uppercase tracking-wider mb-3">
ğŸ“… Multi-Day Run Analysis
</h3>

{runWindows.length > 0 && (
<div className="mb-3">
<div className="text-[10px] font-bold text-green-700 uppercase mb-2">Consecutive Run Windows:</div>
{runWindows.map((window, idx) => (
<div key={idx} className="bg-white p-3 rounded-xl mb-2 border border-green-200">
<div className="flex items-center justify-between">
<span className="text-sm font-bold text-green-900">
{window[0].name} - {window[window.length - 1].name}
</span>
<span className="bg-green-600 text-white text-[9px] font-black px-3 py-1 rounded-full">
{window.length}-DAY RUN
</span>
</div>
</div>
))}
</div>
)}

{best3Day && (
<div className="bg-white p-4 rounded-xl border-2 border-green-300 mb-3">
<div className="text-[10px] font-bold text-green-700 uppercase mb-2">ğŸ† Best 3-Day Window:</div>
<div className="text-lg font-black text-green-900 mb-1">
Starting {best3Day.start}
</div>
<div className="text-xs text-gray-600">
{best3Day.score} out of 3 days favorable for sap flow
</div>
</div>
)}

<div className={`p-4 rounded-xl text-center border-2 ${shouldFire ? 'bg-green-600 border-green-700 text-white' : 'bg-gray-100 border-gray-300 text-gray-700'}`}>
<div className="text-[10px] font-bold uppercase mb-1">
ğŸ”¥ Evaporator Recommendation
</div>
<div className="text-lg font-black">
{shouldFire ? 'âœ… WORTH FIRING UP!' : 'â¸ï¸ Wait for Better Conditions'}
</div>
</div>
</div>
);
}

function SummaryNarrative({ data }) {
const prediction = predictGrade(data.gdd);
const goodRunDays = data.forecast.filter(d => d.isRun).length;
const excellentDays = data.forecast.filter(d => d.sapStatus === 'â­ Excellent').length;
  
let pressureStatus = '';
if (data.press > 30.5) pressureStatus = 'high';
else if (data.press < 29.5) pressureStatus = 'low';
else pressureStatus = 'normal';
  
let seasonPhase = '';
if (data.gdd < 75) seasonPhase = 'early';
else if (data.gdd < 125) seasonPhase = 'mid';
else seasonPhase = 'late';

return (
<div className="bg-gradient-to-br from-blue-50 to-indigo-50 p-5 rounded-3xl shadow-sm border border-blue-200">
<h3 className="text-xs font-black text-blue-900 uppercase tracking-wider mb-3">
ğŸ“– Conditions Summary
</h3>
<div className="text-sm text-blue-900 leading-relaxed space-y-2">
<p>
At <strong>{data.elev} feet</strong> above sea level (where the air is thinner but the syrup dreams are bigger), you're sitting at <strong>{data.press}" pressure</strong>. 
That means water's having an existential crisis at <strong>{data.waterBP}Â°F</strong> instead of the usual 212Â°. Hit <strong>{data.syrupBP}Â°F</strong> to achieve liquid gold status! ğŸ¯
</p>
<p>
{seasonPhase === 'early' && (
<>With <strong>{data.gdd} GDD</strong> on the board, you're catching the <strong>early bird special</strong>â€”buds are snoozing, sap is pristine, and you're on track for 
<strong> {prediction.grade}</strong> that'll make pancakes weep tears of joy. This is the good stuff! ğŸ’</>
)}
{seasonPhase === 'mid' && (
<>Your <strong>{data.gdd} GDD</strong> says we're in the <strong>middle innings</strong>â€”trees are stretching, yawning, and thinking about waking up. 
Keep one eye on those buds! You're brewing <strong>{prediction.grade}</strong> with character that could tell stories. ğŸŒ³</>
)}
{seasonPhase === 'late' && (
<>At <strong>{data.gdd} GDD</strong>, we're in the <strong>final countdown</strong>â€”buds are about to pop like champagne corks! ğŸš¨ 
Your <strong>{prediction.grade}</strong> will pack a flavor punch that doesn't apologize. Taste-test for that dreaded "buddy" funk before bottling! â°</>
)}
</p>
<p>
{goodRunDays > 0 ? (
<>
Mother Nature's dealing you <strong>{goodRunDays} good day{goodRunDays !== 1 ? 's' : ''}</strong>
{excellentDays > 0 && <> (with <strong>{excellentDays}</strong> absolutely *chef's kiss* condition{excellentDays !== 1 ? 's' : ''})</>}. 
{goodRunDays >= 3 ? ' Fire up that evaporatorâ€”it\'s game time! ğŸ”¥' : goodRunDays >= 2 ? ' Decent window here, make it count! ğŸ²' : ' Blink and you\'ll miss it! ğŸ’¨'}
</>
) : (
<>
The freeze-thaw gods are not cooperating right now. Save your firewood and patienceâ€”better days are coming! ğŸ§˜
</>
)}
</p>
</div>
</div>
);
}

function BrixLab(){
const [obs,setObs]=useState(66);
const [temp,setTemp]=useState(211);
const [cal,setCal]=useState(211);
const [showHelp,setShowHelp]=useState(false);
const corrected=(parseFloat(obs)+(temp-cal)*0.047).toFixed(1);

return(
<div className="bg-white p-5 rounded-3xl shadow-sm border border-amber-100">
<div className="flex items-center justify-between mb-3">
<h3 className="text-xs font-black text-amber-900 uppercase tracking-wider">
ğŸ”¬ Brix Correction Lab
</h3>
<button 
onClick={()=>setShowHelp(!showHelp)}
className="w-7 h-7 rounded-full bg-amber-100 text-amber-900 font-black text-sm hover:bg-amber-200 transition-colors"
aria-label="Toggle help information"
>
?
</button>
</div>

{showHelp && (
<div className="mb-4 p-4 bg-blue-50 border-l-4 border-blue-400 rounded-lg text-sm fade-in">
<p className="font-bold text-blue-900 mb-2">ğŸ“˜ How to Use:</p>
<ol className="text-blue-800 space-y-1 text-xs leading-relaxed">
<li><strong>1.</strong> Float your hydrometer in the hot syrup sample</li>
<li><strong>2.</strong> Read the Brix value where the liquid surface meets the scale</li>
<li><strong>3.</strong> Measure the syrup temperature with a thermometer</li>
<li><strong>4.</strong> Enter both values above</li>
<li><strong>5.</strong> Select your hydrometer's calibration temp (check the label)</li>
<li><strong>6.</strong> The corrected Brix shows your true sugar density!</li>
</ol>
<p className="text-blue-700 mt-3 text-xs italic">
ğŸ’¡ <strong>Target:</strong> Finish syrup between 66-67% Brix for optimal density and shelf life.
</p>
</div>
)}

<div className="grid grid-cols-2 gap-3 mb-4">
<div className="col-span-2">
<label htmlFor="obsBrix" className="text-[10px] font-bold text-gray-400 uppercase">
Observed Brix (%)
</label>
<input 
id="obsBrix"
type="number" 
value={obs}
onChange={e=>setObs(e.target.value)}
className="w-full p-3 bg-amber-50 rounded-xl text-lg font-bold outline-none border-2 border-transparent focus:border-amber-200"/>
</div>

<div>
<label htmlFor="syrupTemp" className="text-[10px] font-bold text-gray-400 uppercase">
Syrup Temp Â°F
</label>
<input 
id="syrupTemp"
type="number" 
value={temp}
onChange={e=>setTemp(e.target.value)}
className="w-full p-3 bg-amber-50 rounded-xl text-lg font-bold outline-none border-2 border-transparent focus:border-amber-200"/>
</div>

<div>
<label htmlFor="hydrometerCal" className="text-[10px] font-bold text-gray-400 uppercase">
Hydrometer Cal
</label>
<select 
id="hydrometerCal"
value={cal} 
onChange={e=>setCal(e.target.value)}
className="w-full p-3 bg-amber-50 rounded-xl text-sm font-bold h-[52px]">
<option value="211">Hot (211Â°)</option>
<option value="60">Cold (60Â°)</option>
</select>
</div>
</div>

<div className="bg-orange-50 p-4 rounded-2xl text-center border border-orange-100">
<span className="text-[10px] font-black text-orange-800 block uppercase">
True Brix Result
</span>
<span className="text-4xl font-black text-orange-600">
{corrected}%
</span>
</div>
</div>
);
}

function SugarbushApp(){
const [zip,setZip]=useState('');
const [data,setData]=useState(null);
const [loading,setLoading]=useState(false);
const [error,setError]=useState('');
const [trivia,setTrivia]=useState('');
const [lastZip,setLastZip]=useState('');
const [mode,setMode]=useState('basic');
const errorTimeoutRef = useRef(null);

useEffect(()=>{
setTrivia(triviaList[Math.floor(Math.random()*triviaList.length)]);
const saved = localStorage.getItem('sugarbush_last_zip');
if (saved) {
setLastZip(saved);
}
},[]);

const showError = (msg) => {
setError(msg);
if (errorTimeoutRef.current) clearTimeout(errorTimeoutRef.current);
errorTimeoutRef.current = setTimeout(() => setError(''), 6000);
};

async function analyze(zipToUse = null){
const targetZip = zipToUse || zip;
if(!/^\d{5}$/.test(targetZip.trim())) {
showError("Please enter a valid 5-digit ZIP code");
return;
}
setLoading(true);
setError('');

try{
const zRes=await fetch(`https://api.zippopotam.us/us/${targetZip}`);
if (!zRes.ok) throw new Error('ZIP code not found');
const zData=await zRes.json();
const {latitude:lat,longitude:lon}=zData.places[0];

const pRes=await fetch(`https://api.weather.gov/points/${lat},${lon}`);
if (!pRes.ok) throw new Error('Weather data unavailable');
const pData=await pRes.json();

const gRes=await fetch(pData.properties.forecastGridData);
if (!gRes.ok) throw new Error('Grid data unavailable');
const gridData=await gRes.json();
const elev=gridData.properties.elevation.value*3.28084;

const fRes=await fetch(pData.properties.forecast);
if (!fRes.ok) throw new Error('Forecast unavailable');
const fData=await fRes.json();

const now=new Date();
const diffDays=Math.ceil((now-new Date(now.getFullYear(),0,1))/86400000);

const omRes=await fetch(
`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=surface_pressure&daily=temperature_2m_max,temperature_2m_min&past_days=${diffDays}&timezone=auto&temperature_unit=fahrenheit`
);
if (!omRes.ok) throw new Error('Pressure data unavailable');
const omData=await omRes.json();

const pressInHg=omData.current.surface_pressure*0.02953;
const liveWaterBP=212+(pressInHg-29.92)*1.73;

let totalGDD=0;
omData.daily.time.forEach((_,i)=>{
const h = omData.daily.temperature_2m_max[i];
const l = omData.daily.temperature_2m_min[i];
if (h !== null && l !== null) {
const avg=(h+l)/2;
totalGDD+=Math.max(avg-40,0);
}
});

const periods = fData.properties.periods.slice(0, 14);
const forecast = [];
for (let i = 0; i < periods.length - 1; i += 2) {
const day = periods[i];
const night = periods[i + 1];
const high = day.temperature;
const low = night.temperature;

let sapStatus = '';
let sapClass = '';
let isRun = false;
let isRisk = false;

if (high >= 38 && high <= 50 && low < 32) {
sapStatus = 'â­ Excellent';
sapClass = 'bg-green-100 text-green-700';
isRun = true;
} else if (high >= 35 && high <= 55 && low < 35) {
sapStatus = 'âœ“ Good';
sapClass = 'bg-green-50 text-green-600';
isRun = true;
} else if (high > 55) {
sapStatus = 'ğŸŒ¡ï¸ Too Warm';
sapClass = 'bg-red-50 text-red-600';
isRisk = true;
} else if (low > 32) {
sapStatus = 'ğŸ”¥ No Freeze';
sapClass = 'bg-red-50 text-red-600';
isRisk = true;
} else {
sapStatus = 'â„ï¸ Too Cold';
sapClass = 'bg-gray-100 text-gray-500';
isRisk = true;
}

let warning = '';
const forecastText = (day.shortForecast + ' ' + night.shortForecast).toLowerCase();
if (forecastText.includes('storm') || forecastText.includes('severe') || forecastText.includes('thunder')) {
warning = 'âš ï¸ Storm';
} else if (forecastText.includes('ice') || forecastText.includes('freezing rain')) {
warning = 'ğŸ§Š Ice';
} else if (day.windSpeed && parseInt(day.windSpeed) > 25) {
warning = 'ğŸ’¨ Wind';
} else if (forecastText.includes('snow')) {
warning = 'â„ï¸ Snow';
}

forecast.push({
name: day.name,
high,
low,
sapStatus,
sapClass,
isRun,
isRisk,
warning
});
}

setData({
elev:Math.round(elev),
press:pressInHg.toFixed(2),
waterBP:liveWaterBP.toFixed(1),
syrupBP:(liveWaterBP+7.1).toFixed(1),
gdd:Math.round(totalGDD),
forecast
});

localStorage.setItem('sugarbush_last_zip', targetZip);
setLastZip(targetZip);
setZip(targetZip);

}catch(e){
console.error('Analysis error:', e);
showError('Unable to fetch weather data. Please verify the ZIP code and try again.');
}
setLoading(false);
}

const handleKeyPress = (e) => {
if (e.key === 'Enter' && !loading) {
analyze();
}
};

const loadLastZip = () => {
if (lastZip) {
analyze(lastZip);
}
};

return(
<div className="min-h-screen">
<div className={`mx-auto p-6 pb-12 ${mode === 'advanced' ? 'max-w-7xl' : 'max-w-2xl'}`}>
<header className="text-center py-6">
<h1 className="text-4xl md:text-5xl font-black text-amber-900 tracking-tighter mb-2">
ğŸ Sugarbush Signal
</h1>
<p className="text-xs font-black text-amber-700 uppercase tracking-widest mb-6">
Live Season Intelligence
</p>
<div className="flex justify-center gap-3">
<button
onClick={() => setMode('basic')}
className={`px-6 py-3 rounded-full font-bold text-sm transition-all shadow-md ${
mode === 'basic'
? 'bg-amber-900 text-white shadow-lg scale-105'
: 'bg-white text-amber-900 hover:bg-amber-50'
}`}
>
ğŸ“± Essential
</button>
<button
onClick={() => setMode('advanced')}
className={`px-6 py-3 rounded-full font-bold text-sm transition-all shadow-md ${
mode === 'advanced'
? 'bg-amber-900 text-white shadow-lg scale-105'
: 'bg-white text-amber-900 hover:bg-amber-50'
}`}
>
ğŸ’» Advanced
</button>
</div>
</header>

<div className="bg-white p-5 rounded-3xl shadow-sm mb-6 border-l-8 border-amber-600 italic text-sm text-amber-900 max-w-3xl mx-auto">
"{trivia}"
</div>

<div className="mb-8 max-w-2xl mx-auto">
<div className="flex items-center justify-between mb-2 ml-1">
<label htmlFor="zipInput" className="text-sm font-bold text-amber-900 uppercase">
ZIP Code
</label>
{lastZip && (
<button
onClick={loadLastZip}
className="text-xs font-bold text-amber-600 bg-amber-50 px-4 py-2 rounded-full hover:bg-amber-100 transition-colors"
>
ğŸ“ Last: {lastZip}
</button>
)}
</div>
<div className="flex gap-3">
<input 
id="zipInput"
type="tel" 
value={zip} 
onChange={e=>setZip(e.target.value)}
onKeyPress={handleKeyPress}
placeholder="Enter 5-digit ZIP"
maxLength="5"
disabled={loading}
className={`flex-1 p-4 rounded-2xl border-2 shadow-inner text-lg font-bold focus:border-amber-400 outline-none ${error ? 'border-red-300 error-shake' : 'border-amber-100'} ${loading ? 'opacity-50' : ''}`}
aria-required="true"
aria-describedby={error ? "error-message" : undefined}
/>
<button 
onClick={() => analyze()}
disabled={loading}
className="tap-active bg-amber-900 text-white px-10 py-4 rounded-2xl font-black shadow-lg disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2 text-lg"
>
{loading ? (
<>
<span className="spinner"></span>
</>
) : (
'GO'
)}
</button>
</div>
{error && (
<div 
id="error-message"
role="alert"
className="mt-3 p-4 bg-red-50 border-l-4 border-red-400 text-red-700 text-sm font-semibold rounded-lg fade-in"
>
âš ï¸ {error}
</div>
)}
</div>

{data && (
<div className="fade-in">
{mode === 'basic' ? (
<div className="space-y-6 max-w-2xl mx-auto">
<div className="bg-white rounded-3xl shadow-sm overflow-hidden">
<div className="bg-amber-50 p-3 text-center border-b border-amber-100">
<span className="text-xs font-black text-amber-800 uppercase tracking-wider">
ğŸŒ¤ï¸ 7-Day Forecast
</span>
</div>
{data.forecast.map((day,i)=>(
<div key={i} className="flex items-center justify-between p-4 border-b border-amber-50 last:border-0">
<span className="font-bold text-sm w-24">{day.name}</span>
<div className="flex-1 text-center">
<span className="font-black text-xl text-amber-900">{day.high}Â°</span>
<span className="text-sm text-gray-400 ml-1">/ {day.low}Â°</span>
</div>
<div className="flex flex-col gap-1 items-end w-28">
<span className={`${day.sapClass} text-[9px] font-black px-2 py-1 rounded uppercase`}>
{day.sapStatus}
</span>
{day.warning && (
<span className="bg-yellow-50 text-yellow-700 text-[8px] font-bold px-2 py-0.5 rounded">
{day.warning}
</span>
)}
</div>
</div>
))}
</div>

<div className="grid grid-cols-2 gap-4">
<div className="bg-white p-5 rounded-3xl border border-amber-100 text-center">
<label className="block text-xs font-bold text-gray-400 uppercase mb-1">Baro Pressure</label>
<span className="text-2xl font-black text-amber-900">{data.press}"</span>
</div>
<div className="bg-white p-5 rounded-3xl border border-amber-100 text-center">
<label className="block text-xs font-bold text-gray-400 uppercase mb-1">Elevation</label>
<span className="text-2xl font-black text-amber-900">{data.elev}'</span>
</div>
<div className="bg-amber-100 p-6 rounded-3xl text-center">
<label className="block text-xs font-bold text-amber-800 uppercase mb-1">Water Boils</label>
<span className="text-3xl font-black text-amber-900">{data.waterBP}Â°</span>
</div>
<div className="bg-orange-600 p-6 rounded-3xl text-center text-white ring-8 ring-orange-50">
<label className="block text-xs font-bold opacity-80 uppercase mb-1">ğŸ¯ Finish Syrup</label>
<span className="text-3xl font-black">{data.syrupBP}Â°</span>
</div>
</div>

<RunPredictor forecast={data.forecast} />
<SummaryNarrative data={data} />
<GradingAssistant gdd={data.gdd} />

<div className="bg-white p-5 rounded-3xl shadow-sm border border-amber-100">
<div className="flex justify-between items-end mb-2">
<label className="text-xs font-black text-amber-800 uppercase">
ğŸ“Š Season Vitality (GDD Base 40Â°F)
</label>
<span className="text-sm font-bold text-amber-600">{data.gdd} Units</span>
</div>
<div className="w-full bg-gray-100 h-5 rounded-full overflow-hidden">
<div className="maple-gradient h-full transition-all duration-1000"
style={{width:`${Math.min((data.gdd/150)*100,100)}%`}}></div>
</div>
<p className="text-xs text-gray-600 mt-2 font-bold uppercase text-center">
{data.gdd<75 ? "ğŸŒ³ Buds Dormant - Sap Quality Prime!" : data.gdd<125 ? "ğŸŸ¡ Trees Waking - Monitor Bud Swell" : "ğŸš¨ Bud Swell Imminent - Season Ending!"}
</p>
</div>

<BrixLab/>
</div>
) : (
<div className="space-y-6">
<div className="grid lg:grid-cols-3 gap-6">
<div className="lg:col-span-2 bg-white rounded-3xl shadow-sm overflow-hidden">
<div className="bg-amber-50 p-4 text-center border-b border-amber-100">
<span className="text-sm font-black text-amber-800 uppercase tracking-wider">
ğŸŒ¤ï¸ 7-Day Forecast
</span>
</div>
{data.forecast.map((day,i)=>(
<div key={i} className="flex items-center justify-between p-5 border-b border-amber-50 last:border-0">
<span className="font-bold text-base w-28">{day.name}</span>
<div className="flex-1 text-center">
<span className="font-black text-2xl text-amber-900">{day.high}Â°</span>
<span className="text-base text-gray-400 ml-2">/ {day.low}Â°</span>
</div>
<div className="flex flex-col gap-1 items-end w-32">
<span className={`${day.sapClass} text-[10px] font-black px-3 py-1 rounded uppercase`}>
{day.sapStatus}
</span>
{day.warning && (
<span className="bg-yellow-50 text-yellow-700 text-[9px] font-bold px-2 py-1 rounded">
{day.warning}
</span>
)}
</div>
</div>
))}
</div>

<div className="space-y-4">
<div className="grid grid-cols-2 gap-4">
<div className="bg-white p-5 rounded-3xl border border-amber-100 text-center">
<label className="block text-xs font-bold text-gray-400 uppercase mb-1">Baro Pressure</label>
<span className="text-2xl font-black text-amber-900">{data.press}"</span>
</div>
<div className="bg-white p-5 rounded-3xl border border-amber-100 text-center">
<label className="block text-xs font-bold text-gray-400 uppercase mb-1">Elevation</label>
<span className="text-2xl font-black text-amber-900">{data.elev}'</span>
</div>
</div>
<div className="bg-amber-100 p-6 rounded-3xl text-center">
<label className="block text-xs font-bold text-amber-800 uppercase mb-2">Water Boils</label>
<span className="text-3xl font-black text-amber-900">{data.waterBP}Â°</span>
</div>
<div className="bg-orange-600 p-6 rounded-3xl text-center text-white ring-8 ring-orange-50">
<label className="block text-xs font-bold opacity-80 uppercase mb-2">ğŸ¯ Finish Syrup</label>
<span className="text-3xl font-black">{data.syrupBP}Â°</span>
</div>
</div>
</div>

<div className="grid lg:grid-cols-2 gap-6">
<RunPredictor forecast={data.forecast} />
<SummaryNarrative data={data} />
</div>

<div className="grid lg:grid-cols-2 gap-6">
<GradingAssistant gdd={data.gdd} />
<div className="bg-white p-5 rounded-3xl shadow-sm border border-amber-100">
<div className="flex justify-between items-end mb-3">
<label className="text-xs font-black text-amber-800 uppercase">
ğŸ“Š Season Vitality (GDD Base 40Â°F)
</label>
<span className="text-sm font-bold text-amber-600">{data.gdd} Units</span>
</div>
<div className="w-full bg-gray-100 h-6 rounded-full overflow-hidden mb-3">
<div className="maple-gradient h-full transition-all duration-1000"
style={{width:`${Math.min((data.gdd/150)*100,100)}%`}}></div>
</div>
<p className="text-xs text-gray-600 font-bold uppercase text-center">
{data.gdd<75 ? "ğŸŒ³ Buds Dormant - Sap Quality Prime!" : data.gdd<125 ? "ğŸŸ¡ Trees Waking - Monitor Bud Swell" : "ğŸš¨ Bud Swell Imminent - Season Ending!"}
</p>
</div>
</div>

<AdvancedProductionCalc data={data} />

<BrixLab/>
</div>
)}
</div>
)}
</div>
</div>
);
}

const root=ReactDOM.createRoot(document.getElementById('root'));
root.render(<SugarbushApp/>);
</script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9bae1ca6846be0b5',t:'MTc2NzkwMDY1Mi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
