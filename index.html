<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SapMaster Pro | Maple Syrup Tool</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; line-height: 1.6; color: #333; max-width: 800px; margin: 0 auto; padding: 20px; background-color: #fcf8f2; }
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); border-top: 5px solid #a0522d; }
        h1 { color: #a0522d; text-align: center; margin-bottom: 5px; }
        .subtitle { text-align: center; color: #666; margin-bottom: 30px; font-style: italic; }
        button { background: #a0522d; color: white; border: none; padding: 12px 24px; border-radius: 6px; font-size: 16px; cursor: pointer; width: 100%; font-weight: bold; transition: background 0.3s; }
        button:hover { background: #8b4513; }
        .result-grid { display: grid; grid-template-columns: 1-fr 1fr; gap: 20px; margin-top: 25px; display: none; }
        .stat-box { background: #fdf5e6; padding: 15px; border-radius: 8px; border: 1px solid #e9dcc9; text-align: center; }
        .stat-box h3 { margin-top: 0; font-size: 14px; text-transform: uppercase; color: #8b4513; }
        .stat-box p { font-size: 24px; font-weight: bold; margin: 10px 0 0 0; }
        .forecast-table { width: 100%; margin-top: 30px; border-collapse: collapse; display: none; }
        .forecast-table th, .forecast-table td { padding: 12px; border-bottom: 1px solid #ddd; text-align: left; }
        .run-yes { color: #2e7d32; font-weight: bold; }
        .run-no { color: #d32f2f; }
        .loading { text-align: center; display: none; margin: 20px 0; }
    </style>
</head>
<body>

<div class="card">
    <h1>üçÅ SapMaster Pro</h1>
    <p class="subtitle">Precision Boiling & Sap Run Forecasting</p>
    
    <button onclick="getLocation()">Analyze My Sugarbush</button>

    <div id="loading" class="loading">üì° Gathering atmospheric data...</div>

    <div id="results" class="result-grid">
        <div class="stat-box">
            <h3>Your Elevation</h3>
            <p id="elevText">--</p>
        </div>
        <div class="stat-box">
            <h3>Water Boils At</h3>
            <p id="waterBoil">--</p>
        </div>
        <div class="stat-box" style="grid-column: span 2; background: #fff3e0;">
            <h3>Target Syrup Finish (66% Brix)</h3>
            <p id="syrupFinish" style="color: #d35400;">--</p>
        </div>
    </div>

    <table id="forecast" class="forecast-table">
        <thead>
            <tr>
                <th>Date</th>
                <th>Low / High</th>
                <th>Sap Run Potential</th>
            </tr>
        </thead>
        <tbody id="forecastBody"></tbody>
    </table>
</div>

<script>
    async function getLocation() {
        document.getElementById('loading').style.display = 'block';
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(fetchData, showError);
        } else {
            alert("Geolocation is not supported by this browser.");
        }
    }

    function showError(error) {
        document.getElementById('loading').style.display = 'none';
        alert("Unable to retrieve location. Please check your browser permissions.");
    }

    async function fetchData(position) {
        const lat = position.coords.latitude;
        const lon = position.coords.longitude;

        try {
            const response = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&daily=temperature_2m_max,temperature_2m_min&current_weather=true&elevation=true&timezone=auto&temperature_unit=fahrenheit`);
            const data = await response.json();

            // 1. Calculate Boiling Points
            const elevationFt = data.elevation * 3.28084;
            const waterBoilingPoint = 212 - (elevationFt / 500);
            const syrupFinishPoint = waterBoilingPoint + 7.1;

            // 2. Update UI
            document.getElementById('elevText').innerText = `${Math.round(elevationFt)} ft`;
            document.getElementById('waterBoil').innerText = `${waterBoilingPoint.toFixed(1)}¬∞F`;
            document.getElementById('syrupFinish').innerText = `${syrupFinishPoint.toFixed(1)}¬∞F`;
            
            // 3. Process Forecast
            const forecastBody = document.getElementById('forecastBody');
            forecastBody.innerHTML = '';
            
            for (let i = 0; i < 7; i++) {
                const date = new Date(data.daily.time[i]).toLocaleDateString('en-US', { weekday: 'short', month: 'numeric', day: 'numeric' });
                const low = data.daily.temperature_2m_min[i];
                const high = data.daily.temperature_2m_max[i];
                
                // Sap logic: Freeze at night (<32), Thaw during day (>32)
                const isRun = (low < 32 && high > 34);
                const runStatus = isRun ? '<span class="run-yes">Excellent Run</span>' : '<span class="run-no">No Run</span>';

                forecastBody.innerHTML += `
                    <tr>
                        <td>${date}</td>
                        <td>${low}¬∞ / ${high}¬∞</td>
                        <td>${runStatus}</td>
                    </tr>
                `;
            }

            document.getElementById('loading').style.display = 'none';
            document.getElementById('results').style.display = 'grid';
            document.getElementById('forecast').style.display = 'table';

        } catch (error) {
            console.error(error);
            alert("Error fetching weather data.");
        }
    }
</script>

</body>
</html>
