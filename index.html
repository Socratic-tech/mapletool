<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SapMaster Pro | Trivia Edition</title>
    <style>
        body { font-family: system-ui, sans-serif; background: #fcf8f2; color: #333; padding: 20px; max-width: 800px; margin: 0 auto; }
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); border-top: 8px solid #a0522d; }
        h1 { color: #a0522d; text-align: center; margin-top:0; }
        .trivia-box { background: #fff3e0; border-left: 5px solid #d35400; padding: 15px; margin-bottom: 20px; font-style: italic; font-size: 14px; color: #5d4037; }
        .input-group { display: flex; gap: 10px; margin-bottom: 20px; }
        input { flex: 1; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px; }
        button { padding: 12px 24px; background: #a0522d; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin: 20px 0; display: none; }
        .stat { background: #fdf5e6; padding: 15px; border-radius: 10px; text-align: center; border: 1px solid #e9dcc9; }
        .stat label { display: block; font-size: 11px; font-weight: 800; color: #8b4513; text-transform: uppercase; }
        .stat span { font-size: 22px; font-weight: bold; }
        .forecast { width: 100%; border-collapse: collapse; margin-top: 20px; display: none; }
        .forecast th, .forecast td { padding: 12px; border-bottom: 1px solid #eee; text-align: center; font-size: 14px; }
        .badge { padding: 4px 8px; border-radius: 4px; font-weight: bold; font-size: 12px; }
        .run { background: #e8f5e9; color: #2e7d32; }
        .risk { background: #ffebee; color: #c62828; }
        .debug { background: #333; color: #0f0; padding: 15px; border-radius: 6px; font-family: monospace; font-size: 11px; margin-top: 20px; display: none; }
    </style>
</head>
<body>

<div class="card">
    <h1>üçÅ SapMaster Pro</h1>
    
    <div id="trivia" class="trivia-box">Loading maple trivia...</div>

    <div class="input-group">
        <input type="text" id="zipInput" placeholder="Enter US ZIP Code" maxlength="5">
        <button onclick="runAnalysis()">Analyze</button>
    </div>

    <div id="dashboard" class="grid">
        <div class="stat"><label>Grid Elevation</label><span id="val-elev">--</span></div>
        <div class="stat"><label>Water Boils At</label><span id="val-water">--</span></div>
        <div class="stat" style="border: 2px solid #d35400;"><label>Finish Syrup At</label><span id="val-syrup" style="color:#d35400;">--</span></div>
    </div>

    <table id="forecastTable" class="forecast">
        <thead>
            <tr><th>Day</th><th>High / Low</th><th>Sap Flow</th><th>Safety</th></tr>
        </thead>
        <tbody id="forecastBody"></tbody>
    </table>

    <div id="debugLog" class="debug"></div>
</div>

<script>
    const facts = [
        "It takes approximately 40 gallons of sap to make just 1 gallon of finished maple syrup.",
        "A maple tree needs to be about 40 years old and 10-12 inches in diameter before it can be tapped.",
        "Maple syrup contains more calcium than an equivalent amount of milk and more potassium than a banana.",
        "Native Americans were the first to discover the 'sweet water' of the maple tree.",
        "A single tap can yield 5 to 15 gallons of sap per season without harming the tree.",
        "Sugar Maples are preferred because their sap has the highest sugar content (usually 2%).",
        "Quebec, Canada produces over 70% of the entire world's maple syrup supply.",
        "Light colored syrup (Grade A: Golden) is usually made earlier in the season when it is colder."
    ];

    // Load trivia on start
    window.onload = () => {
        const randomFact = facts[Math.floor(Math.random() * facts.length)];
        document.getElementById('trivia').innerText = "Did you know? " + randomFact;
    };

    async function runAnalysis() {
        const zip = document.getElementById('zipInput').value;
        const debug = document.getElementById('debugLog');
        debug.innerHTML = '';
        
        if (!/^\d{5}$/.test(zip)) return alert("Please enter a valid 5-digit ZIP.");

        try {
            // 1. ZIP to Lat/Lon
            const zipRes = await fetch(`https://api.zippopotam.us/us/${zip}`);
            const zipData = await zipRes.json();
            const lat = zipData.places[0].latitude;
            const lon = zipData.places[0].longitude;

            // 2. Get NWS Metadata
            const nwsPointsRes = await fetch(`https://api.weather.gov/points/${lat},${lon}`);
            const pointsData = await nwsPointsRes.json();
            
            // 3. Get Elevation from Grid
            const gridRes = await fetch(pointsData.properties.forecastGridData);
            const gridData = await gridRes.json();
            const elevFt = gridData.properties.elevation.value * 3.28084;

            // 4. Get Forecast
            const forecastRes = await fetch(pointsData.properties.forecast);
            const forecastData = await forecastRes.json();

            // 5. Calculations
            const waterBoil = 212 - (elevFt / 500);
            const syrupFinish = waterBoil + 7.1;

            // Update Stats
            document.getElementById('val-elev').innerText = Math.round(elevFt) + " ft";
            document.getElementById('val-water').innerText = waterBoil.toFixed(1) + "¬∞F";
            document.getElementById('val-syrup').innerText = syrupFinish.toFixed(1) + "¬∞F";

            // Update Forecast (Flipped Temp)
            const tbody = document.getElementById('forecastBody');
            tbody.innerHTML = '';
            const periods = forecastData.properties.periods;
            
            for (let i = 0; i < periods.length; i += 2) {
                const day = periods[i]; 
                const night = periods[i+1]; 
                if (!night) break;

                // Physics check for flow and safety
                const isRun = (night.temperature < 32 && day.temperature > 34);
                const isRisk = (day.temperature > 45 || night.temperature > 38);

                tbody.innerHTML += `
                    <tr>
                        <td>${day.name}</td>
                        <td><strong>${day.temperature}¬∞</strong> / ${night.temperature}¬∞</td>
                        <td>${isRun ? '<span class="badge run">RUNNING</span>' : '--'}</td>
                        <td>${isRisk ? '<span class="badge risk">BOIL NOW</span>' : '‚úÖ SAFE'}</td>
                    </tr>`;
            }

            document.getElementById('dashboard').style.display = 'grid';
            document.getElementById('forecastTable').style.display = 'table';

        } catch (err) {
            alert("Analysis failed. Check your internet connection or ZIP code.");
        }
    }
</script>
</body>
</html>
